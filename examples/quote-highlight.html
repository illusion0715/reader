<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EPUB.js è«å…°è¿ª AI å¢å¼ºç‰ˆ</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>

    <link rel="stylesheet" type="text/css" href="examples.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style type="text/css">
        :root {
            --primary-color: #779ECB;
            --bg-dark: #1a1a2e;
            --sidebar-bg: rgba(26, 26, 46, 0.98);
        }

        body {
            margin: 0;
            background: var(--bg-dark);
            font-family: "Microsoft YaHei", sans-serif;
            color: #e0e0e0;
            overflow: hidden;
        }

        /* å³ä¾§è¾¹æ  */
        #sidebar {
            position: fixed;
            top: 0;
            right: -360px;
            width: 360px;
            height: 100vh;
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            z-index: 2000;
            transition: right 0.35s ease;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        #sidebar.open {
            right: 0;
        }

        /* å·¦ä¾§ AI é¢æ¿ */
        #ai-panel {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: linear-gradient(180deg, #0d0d1a 0%, #1a1a2e 100%);
            z-index: 2000;
            transition: left 0.35s ease;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(119, 158, 203, 0.2);
            box-shadow: 5px 0 30px rgba(0, 0, 0, 0.5);
        }

        #ai-panel.open {
            left: 0;
        }

        .ai-header {
            padding: 20px;
            background: linear-gradient(90deg, rgba(119, 158, 203, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-header .icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #779ECB 0%, #8FBC8F 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #fff;
        }

        .ai-header .title {
            flex: 1;
        }

        .ai-header .title h3 {
            margin: 0;
            font-size: 16px;
            color: #eee;
        }

        .ai-header .title p {
            margin: 4px 0 0;
            font-size: 11px;
            color: #888;
        }

        .ai-header .close-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .ai-msg {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-msg.user {
            display: flex;
            justify-content: flex-end;
        }

        .ai-msg.user .bubble {
            background: linear-gradient(135deg, #779ECB 0%, #5a7fb0 100%);
            color: #fff;
            border-radius: 16px 16px 4px 16px;
            padding: 12px 16px;
            max-width: 85%;
            font-size: 13px;
            line-height: 1.6;
        }

        .ai-msg.assistant .bubble {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px 16px 16px 4px;
            padding: 16px;
            max-width: 95%;
            font-size: 13px;
            line-height: 1.8;
            color: #ccc;
        }

        /* Markdown æ ·å¼ */
        .ai-msg.assistant .bubble h1,
        .ai-msg.assistant .bubble h2,
        .ai-msg.assistant .bubble h3 {
            color: #779ECB;
            margin: 16px 0 8px 0;
            border-bottom: 1px solid rgba(119, 158, 203, 0.3);
            padding-bottom: 6px;
        }

        .ai-msg.assistant .bubble h1 {
            font-size: 18px;
        }

        .ai-msg.assistant .bubble h2 {
            font-size: 16px;
        }

        .ai-msg.assistant .bubble h3 {
            font-size: 14px;
            border-bottom: none;
        }

        .ai-msg.assistant .bubble strong {
            color: #E1AD01;
            font-weight: bold;
        }

        .ai-msg.assistant .bubble em {
            color: #8FBC8F;
            font-style: italic;
        }

        .ai-msg.assistant .bubble ul,
        .ai-msg.assistant .bubble ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .ai-msg.assistant .bubble li {
            margin: 6px 0;
        }

        .ai-msg.assistant .bubble blockquote {
            border-left: 3px solid #779ECB;
            margin: 10px 0;
            padding: 8px 15px;
            background: rgba(119, 158, 203, 0.1);
            border-radius: 0 8px 8px 0;
        }

        .ai-msg.assistant .bubble code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: Consolas, monospace;
            font-size: 12px;
        }

        .ai-msg.assistant .bubble pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .ai-msg.assistant .bubble hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 15px 0;
        }

        .ai-msg.system .bubble {
            background: rgba(119, 158, 203, 0.1);
            border-left: 3px solid #779ECB;
            padding: 10px 15px;
            font-size: 12px;
            color: #888;
        }

        .ai-input-area {
            padding: 15px 20px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-attachments {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .attachment-item {
            background: rgba(119, 158, 203, 0.15);
            border: 1px solid rgba(119, 158, 203, 0.3);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 11px;
            color: #779ECB;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .attachment-item .remove {
            cursor: pointer;
            opacity: 0.6;
        }

        .attachment-item .remove:hover {
            opacity: 1;
        }

        .ai-input-box {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .ai-input-box textarea {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 15px;
            color: #eee;
            font-size: 13px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }

        .ai-input-box textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .ai-input-box textarea::placeholder {
            color: #666;
        }

        .ai-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ai-action-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .ai-action-btn:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }

        .ai-action-btn.send {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }

        .ai-quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #888;
            font-size: 11px;
            cursor: pointer;
            transition: 0.2s;
        }

        .quick-btn:hover {
            background: rgba(119, 158, 203, 0.1);
            border-color: rgba(119, 158, 203, 0.3);
            color: var(--primary-color);
        }

        /* å·¦ä¾§ AI æŒ‰é’® */
        #ai-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #779ECB 0%, #8FBC8F 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            z-index: 1000;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(119, 158, 203, 0.4);
            transition: 0.3s;
        }

        #ai-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(119, 158, 203, 0.5);
        }

        .prompt-tag {
            padding: 4px 10px;
            background: rgba(119, 158, 203, 0.15);
            border: 1px solid rgba(119, 158, 203, 0.3);
            border-radius: 12px;
            font-size: 11px;
            color: #779ECB;
            cursor: pointer;
            transition: 0.2s;
        }

        .prompt-tag:hover {
            background: rgba(119, 158, 203, 0.3);
            border-color: var(--primary-color);
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .tab-btn {
            flex: 1;
            padding: 14px 5px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 11px;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .data-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            position: relative;
        }

        .data-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .data-item .title {
            font-size: 13px;
            color: #eee;
            display: block;
        }

        .data-item.active {
            border-left: 3px solid var(--primary-color);
        }

        .delete-btn {
            position: absolute;
            top: 12px;
            right: 10px;
            color: #ff5e5e;
            opacity: 0;
            cursor: pointer;
        }

        .data-item:hover .delete-btn {
            opacity: 0.7;
        }

        #toolbar {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
            opacity: 0.5;
            transition: 0.3s;
        }

        #toolbar:hover {
            opacity: 1;
        }

        .tool-btn {
            background: rgba(42, 42, 74, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        #highlight-menu {
            position: fixed;
            background: #fff;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            padding: 8px 15px;
            display: none;
            z-index: 3000;
            gap: 12px;
            align-items: center;
        }

        .color-opt {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .ai-opt {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            background: #eee;
            border-radius: 50%;
            cursor: pointer;
        }

        #note-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .modal-content {
            background: #222;
            padding: 20px;
            border-radius: 12px;
            width: 300px;
        }

        .modal-content textarea {
            width: 100%;
            height: 100px;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            resize: none;
            box-sizing: border-box;
        }

        .modal-btns {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        #viewer {
            width: 100%;
            height: 100vh;
        }

        .arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 30px;
            color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            padding: 40px 10px;
            z-index: 100;
        }

        .arrow:hover {
            color: var(--primary-color);
        }

        #menu-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            cursor: pointer;
            z-index: 1000;
            font-size: 18px;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        #overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .filter-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .filter-dot.active {
            border-color: #fff;
        }

        .note-preview {
            font-size: 11px;
            color: #E1AD01;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body>
    <div id="viewer"></div>
    <div id="prev" class="arrow" style="left:10px;"><i class="fas fa-chevron-left"></i></div>
    <div id="next" class="arrow" style="right:10px;"><i class="fas fa-chevron-right"></i></div>
    <div id="overlay"></div>

    <!-- å·¦ä¾§ AI æŒ‰é’® -->
    <div id="ai-toggle"><i class="fas fa-robot"></i></div>

    <!-- å·¦ä¾§ AI é¢æ¿ -->
    <div id="ai-panel">
        <div class="ai-header">
            <div class="icon"><i class="fas fa-brain"></i></div>
            <div class="title">
                <h3>AI é˜…è¯»åŠ©æ‰‹</h3>
                <p>åŸºäºå½“å‰ä¹¦ç±çš„æ™ºèƒ½é—®ç­”</p>
            </div>
            <button class="close-btn" onclick="toggleAIPanel()"><i class="fas fa-times"></i></button>
        </div>

        <div class="ai-messages" id="ai-messages">
            <div class="ai-msg system">
                <div class="bubble">
                    <i class="fas fa-info-circle"></i> æˆ‘æ˜¯æ‚¨çš„ AI é˜…è¯»åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥ï¼š<br>
                    â€¢ ç›´æ¥è¾“å…¥é—®é¢˜è¿›è¡Œå¯¹è¯<br>
                    â€¢ ä¸Šä¼ å›¾ç‰‡æˆ–æ–‡ä»¶ä½œä¸ºå‚è€ƒ<br>
                    â€¢ ç‚¹å‡»ä¸‹æ–¹å¿«æ·æŒ‰é’®å¿«é€Ÿæ“ä½œ
                </div>
            </div>
        </div>

        <div class="ai-input-area">
            <div class="ai-attachments" id="ai-attachments"></div>
            <div class="ai-input-box">
                <textarea id="ai-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="1" onkeydown="handleInputKey(event)"></textarea>
                <div class="ai-actions">
                    <label class="ai-action-btn" title="ä¸Šä¼ å›¾ç‰‡">
                        <i class="fas fa-image"></i>
                        <input type="file" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
                    </label>
                    <label class="ai-action-btn" title="ä¸Šä¼ æ–‡ä»¶">
                        <i class="fas fa-paperclip"></i>
                        <input type="file" accept=".txt,.pdf,.doc,.docx" style="display:none"
                            onchange="handleFileUpload(event)">
                    </label>
                    <button class="ai-action-btn send" onclick="sendAIMessage()"><i
                            class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            <div class="ai-quick-actions">
                <button class="quick-btn" onclick="quickAction('summary')"><i class="fas fa-compress-alt"></i>
                    æ€»ç»“å…¨ä¹¦</button>
                <button class="quick-btn" onclick="quickAction('explain')"><i class="fas fa-lightbulb"></i>
                    è§£è¯»é€‰ä¸­</button>
                <button class="quick-btn" onclick="quickAction('translate')"><i class="fas fa-language"></i> ç¿»è¯‘</button>
            </div>
            <div style="margin-top:10px; text-align:center;">
                <button class="quick-btn" style="width:100%;" onclick="toggleAISettings()"><i class="fas fa-cog"></i> AI
                    è®¾ç½®</button>
            </div>
            <div id="ai-settings-panel"
                style="display:none; margin-top:10px; padding:10px; background:rgba(0,0,0,0.3); border-radius:8px;">
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-size:11px;color:#888;margin-bottom:4px;">API åœ°å€</label>
                    <input type="text" id="ai-url" placeholder="https://api.openai.com/v1"
                        style="width:100%;padding:6px;background:#222;border:1px solid #444;color:#fff;border-radius:4px;box-sizing:border-box;font-size:12px;">
                </div>
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-size:11px;color:#888;margin-bottom:4px;">API Key</label>
                    <input type="password" id="ai-key"
                        style="width:100%;padding:6px;background:#222;border:1px solid #444;color:#fff;border-radius:4px;box-sizing:border-box;font-size:12px;">
                </div>
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-size:11px;color:#888;margin-bottom:4px;">æ¨¡å‹</label>
                    <input type="text" id="ai-model" placeholder="gpt-3.5-turbo"
                        style="width:100%;padding:6px;background:#222;border:1px solid #444;color:#fff;border-radius:4px;box-sizing:border-box;font-size:12px;">
                </div>
                <div style="margin-bottom:12px;">
                    <label style="display:block;font-size:11px;color:#888;margin-bottom:4px;">ç³»ç»Ÿæç¤ºè¯</label>
                    <textarea id="ai-system-prompt" rows="3" placeholder="ä½ æ˜¯ä¸“ä¸šçš„é˜…è¯»åŠ©æ‰‹..."
                        style="width:100%;padding:6px;background:#222;border:1px solid #444;color:#fff;border-radius:4px;box-sizing:border-box;font-size:12px;resize:vertical;"></textarea>
                    <div style="margin-top:6px;display:flex;gap:4px;flex-wrap:wrap;">
                        <span class="prompt-tag" onclick="setPromptPreset('reader')">ğŸ“š è§£è¯»</span>
                        <span class="prompt-tag" onclick="setPromptPreset('analyst')">ğŸ” åˆ†æ</span>
                        <span class="prompt-tag" onclick="setPromptPreset('teacher')">ğŸ‘¨â€ğŸ« æ•™å­¦</span>
                        <span class="prompt-tag" onclick="setPromptPreset('translator')">ğŸŒ ç¿»è¯‘</span>
                    </div>
                </div>
                <button onclick="saveSettings()"
                    style="width:100%;padding:8px;background:var(--primary-color);border:none;border-radius:4px;cursor:pointer;font-size:12px;">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <div id="toolbar">
        <label for="import-file" class="tool-btn"><i class="fas fa-plus"></i> æ·»åŠ ä¹¦ç±</label>
        <input type="file" id="import-file" accept=".epub" style="display:none">
        <button class="tool-btn" onclick="addBookmark()"><i class="fas fa-bookmark"></i> è®°ä¹¦ç­¾</button>
        <span id="page-info" style="font-size:11px; align-self:center; color:#888; margin-left:10px;">...</span>
    </div>

    <div id="menu-toggle"><i class="fas fa-bars"></i></div>

    <div id="sidebar">
        <div class="sidebar-tabs">
            <button class="tab-btn active" data-tab="library">ä¹¦åº“</button>
            <button class="tab-btn" data-tab="toc">ç›®å½•</button>
            <button class="tab-btn" data-tab="bookmarks">ä¹¦ç­¾</button>
            <button class="tab-btn" data-tab="highlights">é«˜äº®</button>
            <button class="tab-btn" data-tab="settings">è®¾ç½®</button>
        </div>

        <div class="tab-content">
            <div id="pane-library" class="tab-pane active">
                <div id="library-container"></div>
            </div>
            <div id="pane-toc" class="tab-pane">
                <div id="toc-container"></div>
            </div>
            <div id="pane-bookmarks" class="tab-pane">
                <div id="bookmark-container"></div>
            </div>
            <div id="pane-highlights" class="tab-pane">
                <div class="filter-bar">
                    <div class="filter-dot active"
                        style="background:#444;display:flex;align-items:center;justify-content:center;color:#fff;font-size:8px;"
                        data-filter="all">ALL</div>
                    <div class="filter-dot" style="background:#779ECB" data-filter="#779ECB"></div>
                    <div class="filter-dot" style="background:#8FBC8F" data-filter="#8FBC8F"></div>
                    <div class="filter-dot" style="background:#C08081" data-filter="#C08081"></div>
                    <div class="filter-dot" style="background:#E1AD01" data-filter="#E1AD01"></div>
                </div>
                <div id="highlight-container"></div>
            </div>
            <div id="pane-settings" class="tab-pane">
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-size:12px; color:#888; margin-bottom:8px;">å¼•å·é«˜äº®é¢œè‰²</label>
                    <div style="display:flex; gap:8px;">
                        <div class="color-opt" style="background:#779ECB"
                            onclick="document.getElementById('cfg-color').value='#779ECB'"></div>
                        <div class="color-opt" style="background:#8FBC8F"
                            onclick="document.getElementById('cfg-color').value='#8FBC8F'"></div>
                        <div class="color-opt" style="background:#C08081"
                            onclick="document.getElementById('cfg-color').value='#C08081'"></div>
                        <div class="color-opt" style="background:#E1AD01"
                            onclick="document.getElementById('cfg-color').value='#E1AD01'"></div>
                    </div>
                    <input type="color" id="cfg-color" value="#779ECB"
                        style="width:100%; height:30px; margin-top:10px; border:none; box-sizing:border-box;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-size:12px; color:#888; margin-bottom:8px;">å¼•å·å¯¹ï¼ˆå·¦å¼•å· / å³å¼•å·ï¼‰</label>
                    <div style="display:flex; gap:10px; width:100%; box-sizing:border-box;">
                        <input type="text" id="cfg-lq" value=""" style=" width:50%; padding:8px; background:#222;
                            border:1px solid #444; color:#fff; border-radius:4px; text-align:center; font-size:18px;
                            box-sizing:border-box;">
                        <input type="text" id="cfg-rq" value=""" style=" width:50%; padding:8px; background:#222;
                            border:1px solid #444; color:#fff; border-radius:4px; text-align:center; font-size:18px;
                            box-sizing:border-box;">
                    </div>
                    <p style="font-size:11px; color:#666; margin-top:8px;">æç¤ºï¼šä¸­æ–‡ç”¨ " å’Œ "ï¼Œè‹±æ–‡ç”¨ " å’Œ "</p>
                </div>
                <button onclick="saveSettings()"
                    style="width:100%; padding:12px; background:var(--primary-color); border:none; border-radius:6px; font-weight:bold; cursor:pointer; box-sizing:border-box;">ä¿å­˜å¼•å·è®¾ç½®</button>
            </div>
        </div>
    </div>

    <div id="highlight-menu">
        <div class="color-opt" style="background:#779ECB" onclick="doHighlight('#779ECB')"></div>
        <div class="color-opt" style="background:#8FBC8F" onclick="doHighlight('#8FBC8F')"></div>
        <div class="color-opt" style="background:#C08081" onclick="doHighlight('#C08081')"></div>
        <div class="color-opt" style="background:#E1AD01" onclick="doHighlight('#E1AD01')"></div>
        <div style="width:1px; height:20px; background:#ddd;"></div>
        <div class="ai-opt" onclick="sendSelectedToAI()"><i class="fas fa-robot"></i></div>
    </div>

    <div id="note-modal">
        <div class="modal-content">
            <h4 style="margin-top:0; color:#eee;">æ·»åŠ æ„Ÿæƒ³</h4>
            <textarea id="note-text" placeholder="å†™ä¸‹ä½ çš„è¯»ä¹¦å¿ƒå¾—..."></textarea>
            <div class="modal-btns">
                <button class="tool-btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="tool-btn" style="background:var(--primary-color);color:#000;"
                    onclick="saveNote()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€å˜é‡ ==========
        var db, book, rendition, currentBookId, currentCfi, currentContents;
        var hlFilter = 'all';
        var aiAttachments = [];
        var data = {
            progress: '',
            bookmarks: [],
            highlights: [],
            config: { color: '#779ECB', lq: '"', rq: '"', aiUrl: '', aiKey: '', aiModel: 'gpt-3.5-turbo', systemPrompt: '' }
        };

        // ========== æ•°æ®åº“åˆå§‹åŒ– ==========
        var dbReq = indexedDB.open('EPUBReader', 1);
        dbReq.onupgradeneeded = function (e) {
            e.target.result.createObjectStore('books', { keyPath: 'id' });
        };
        dbReq.onsuccess = function (e) {
            db = e.target.result;
            init();
        };
        dbReq.onerror = function (e) {
            console.error('æ•°æ®åº“é”™è¯¯:', e);
            init();
        };

        // ========== åˆå§‹åŒ– ==========
        function init() {
            setupEvents();
            refreshLibrary();
            var lastBook = localStorage.getItem('lastBook');
            if (lastBook && db) {
                loadBook(lastBook);
            } else {
                loadFromUrl('https://s3.amazonaws.com/moby-dick/moby-dick.epub', 'Moby Dick', 'default');
            }
        }

        function setupEvents() {
            document.getElementById('menu-toggle').onclick = toggleSidebar;
            document.getElementById('overlay').onclick = function () {
                if (document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
                if (document.getElementById('ai-panel').classList.contains('open')) toggleAIPanel();
            };
            document.getElementById('ai-toggle').onclick = toggleAIPanel;

            document.querySelectorAll('.tab-btn').forEach(function (btn) {
                btn.onclick = function () {
                    document.querySelectorAll('.tab-btn').forEach(function (b) { b.classList.remove('active'); });
                    document.querySelectorAll('.tab-pane').forEach(function (p) { p.classList.remove('active'); });
                    btn.classList.add('active');
                    document.getElementById('pane-' + btn.dataset.tab).classList.add('active');
                };
            });

            document.getElementById('next').onclick = function () { if (rendition) rendition.next(); };
            document.getElementById('prev').onclick = function () { if (rendition) rendition.prev(); };

            document.getElementById('import-file').onchange = function (e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function (ev) {
                    var id = 'book_' + Date.now();
                    if (db) {
                        var tx = db.transaction('books', 'readwrite');
                        tx.objectStore('books').put({ id: id, name: file.name, data: ev.target.result });
                        tx.oncomplete = function () {
                            refreshLibrary();
                            loadBook(id);
                        };
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            document.querySelectorAll('.filter-dot').forEach(function (dot) {
                dot.onclick = function () {
                    document.querySelectorAll('.filter-dot').forEach(function (d) { d.classList.remove('active'); });
                    dot.classList.add('active');
                    hlFilter = dot.dataset.filter;
                    refreshHighlights();
                };
            });

            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            document.getElementById('ai-input').addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function toggleAIPanel() {
            document.getElementById('ai-panel').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function toggleAISettings() {
            var panel = document.getElementById('ai-settings-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // ========== AI é¢æ¿åŠŸèƒ½ ==========
        function handleInputKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIMessage();
            }
        }

        function handleImageUpload(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) {
                aiAttachments.push({ type: 'image', name: file.name, data: ev.target.result });
                refreshAttachments();
            };
            reader.readAsDataURL(file);
        }

        function handleFileUpload(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (ev) {
                aiAttachments.push({ type: 'file', name: file.name, data: ev.target.result });
                refreshAttachments();
            };
            reader.readAsText(file);
        }

        function refreshAttachments() {
            var container = document.getElementById('ai-attachments');
            container.innerHTML = aiAttachments.map(function (a, i) {
                return '<div class="attachment-item"><i class="fas fa-' + (a.type === 'image' ? 'image' : 'file') + '"></i> ' + a.name + ' <span class="remove" onclick="removeAttachment(' + i + ')"><i class="fas fa-times"></i></span></div>';
            }).join('');
        }

        function removeAttachment(idx) {
            aiAttachments.splice(idx, 1);
            refreshAttachments();
        }

        function addAIMessage(role, content) {
            var container = document.getElementById('ai-messages');
            var div = document.createElement('div');
            div.className = 'ai-msg ' + role;
            div.innerHTML = '<div class="bubble">' + content + '</div>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendAIMessage() {
            var input = document.getElementById('ai-input');
            var text = input.value.trim();
            if (!text && aiAttachments.length === 0) return;

            var url = data.config.aiUrl || 'https://api.openai.com/v1';
            var key = data.config.aiKey;
            if (!key) {
                alert('è¯·åœ¨å³ä¾§è®¾ç½®é¢æ¿ä¸­é…ç½® API Key');
                return;
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            var userContent = text;
            if (aiAttachments.length > 0) {
                userContent += '<br><small style="color:#888;">[é™„ä»¶: ' + aiAttachments.map(function (a) { return a.name; }).join(', ') + ']</small>';
            }
            addAIMessage('user', userContent);

            input.value = '';
            input.style.height = 'auto';

            // æ„å»ºæ¶ˆæ¯
            var messages = [];
            // æ·»åŠ ç³»ç»Ÿæç¤ºè¯
            var sysPrompt = data.config.systemPrompt || 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é˜…è¯»åŠ©æ‰‹ï¼Œæ“…é•¿æ·±åº¦è§£è¯»æ–‡æœ¬ï¼Œåˆ†æä½œè€…æ„å›¾å’Œæ–‡å­¦æŠ€å·§ï¼Œå¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£ä¹¦ç±å†…å®¹ã€‚è¯·ç”¨ç»“æ„åŒ–çš„æ–¹å¼å›ç­”ï¼Œä½¿ç”¨ Markdown æ ¼å¼ã€‚';
            messages.push({ role: 'system', content: sysPrompt });
            messages.push({ role: 'user', content: text });

            // å¦‚æœæœ‰å›¾ç‰‡é™„ä»¶ï¼Œä½¿ç”¨ vision æ ¼å¼
            if (aiAttachments.some(function (a) { return a.type === 'image'; })) {
                var contentParts = [{ type: 'text', text: text }];
                aiAttachments.forEach(function (a) {
                    if (a.type === 'image') {
                        contentParts.push({ type: 'image_url', image_url: { url: a.data } });
                    }
                });
                messages = [{ role: 'user', content: contentParts }];
            }

            // å¦‚æœæœ‰æ–‡ä»¶é™„ä»¶ï¼Œæ·»åŠ åˆ°æ–‡æœ¬ä¸­
            aiAttachments.forEach(function (a) {
                if (a.type === 'file') {
                    text += '\n\n[é™„ä»¶å†…å®¹ ' + a.name + ']:\n' + a.data;
                }
            });

            aiAttachments = [];
            refreshAttachments();

            addAIMessage('assistant', '<span id="stream-content"></span><i class="fas fa-spinner fa-spin" id="stream-spinner"></i>');

            fetch(url + '/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
                body: JSON.stringify({ model: data.config.aiModel || 'gpt-3.5-turbo', messages: messages, stream: true })
            }).then(function (response) {
                var reader = response.body.getReader();
                var decoder = new TextDecoder();
                var fullContent = '';
                var streamEl = document.getElementById('stream-content');

                function read() {
                    reader.read().then(function (result) {
                        if (result.done) {
                            var spinner = document.getElementById('stream-spinner');
                            if (spinner) spinner.remove();
                            try { streamEl.innerHTML = marked.parse(fullContent); } catch (e) { }
                            return;
                        }
                        var chunk = decoder.decode(result.value, { stream: true });
                        var lines = chunk.split('\n');
                        lines.forEach(function (line) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try {
                                    var json = JSON.parse(line.slice(6));
                                    if (json.choices && json.choices[0].delta && json.choices[0].delta.content) {
                                        fullContent += json.choices[0].delta.content;
                                        streamEl.textContent = fullContent;
                                    }
                                } catch (e) { }
                            }
                        });
                        document.getElementById('ai-messages').scrollTop = document.getElementById('ai-messages').scrollHeight;
                        read();
                    });
                }
                read();
            }).catch(function (e) {
                var lastMsg = document.querySelector('#ai-messages .ai-msg:last-child');
                if (lastMsg) lastMsg.remove();
                addAIMessage('assistant', 'è¿æ¥å¤±è´¥: ' + e.message);
            });
        }

        function quickAction(action) {
            var input = document.getElementById('ai-input');
            if (action === 'summary') {
                extractFullText().then(function (text) {
                    input.value = 'è¯·æ€»ç»“ä»¥ä¸‹ä¹¦ç±çš„æ ¸å¿ƒå†…å®¹ï¼š\n\n' + text.substring(0, 10000);
                    sendAIMessage();
                });
            } else if (action === 'explain') {
                if (currentCfi) {
                    book.getRange(currentCfi).then(function (r) {
                        if (r) {
                            input.value = 'è¯·è§£è¯»ä»¥ä¸‹æ–‡æœ¬çš„æ·±å±‚å«ä¹‰ï¼š\n\n' + r.toString();
                            sendAIMessage();
                        }
                    });
                } else {
                    alert('è¯·å…ˆåœ¨æ­£æ–‡ä¸­é€‰ä¸­ä¸€æ®µæ–‡å­—');
                }
            } else if (action === 'translate') {
                if (currentCfi) {
                    book.getRange(currentCfi).then(function (r) {
                        if (r) {
                            input.value = 'è¯·å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆä¸­æ–‡ï¼š\n\n' + r.toString();
                            sendAIMessage();
                        }
                    });
                } else {
                    alert('è¯·å…ˆåœ¨æ­£æ–‡ä¸­é€‰ä¸­ä¸€æ®µæ–‡å­—');
                }
            }
        }

        function sendSelectedToAI() {
            if (!currentCfi) return;
            book.getRange(currentCfi).then(function (r) {
                if (r) {
                    document.getElementById('ai-input').value = 'è¯·è§£è¯»ä»¥ä¸‹æ–‡æœ¬ï¼š\n\n' + r.toString();
                    toggleAIPanel();
                    document.getElementById('highlight-menu').style.display = 'none';
                }
            });
        }

        // ========== ä¹¦åº“ ==========
        function refreshLibrary() {
            var container = document.getElementById('library-container');
            if (!db) {
                container.innerHTML = '<p style="text-align:center;color:#666;">æ•°æ®åº“åŠ è½½ä¸­...</p>';
                return;
            }
            var tx = db.transaction('books', 'readonly');
            var req = tx.objectStore('books').getAll();
            req.onsuccess = function () {
                var books = req.result;
                if (books.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;">ä¹¦åº“ä¸ºç©ºï¼Œè¯·æ·»åŠ ä¹¦ç±</p>';
                } else {
                    container.innerHTML = books.map(function (b) {
                        return '<div class="data-item ' + (b.id === currentBookId ? 'active' : '') + '" onclick="loadBook(\'' + b.id + '\')">' +
                            '<span class="title">' + b.name + '</span>' +
                            '<i class="fas fa-trash delete-btn" onclick="event.stopPropagation(); deleteBook(\'' + b.id + '\')"></i>' +
                            '</div>';
                    }).join('');
                }
            };
        }

        function loadBook(id) {
            if (!db) return;
            var tx = db.transaction('books', 'readonly');
            var req = tx.objectStore('books').get(id);
            req.onsuccess = function () {
                if (req.result) {
                    startReader(req.result.data, req.result.name, id);
                }
            };
        }

        function deleteBook(id) {
            if (!confirm('ç¡®å®šåˆ é™¤?')) return;
            var tx = db.transaction('books', 'readwrite');
            tx.objectStore('books').delete(id);
            tx.oncomplete = function () {
                localStorage.removeItem('data_' + id);
                refreshLibrary();
            };
        }

        function loadFromUrl(url, name, id) {
            fetch(url).then(function (r) { return r.arrayBuffer(); }).then(function (ab) {
                startReader(ab, name, id);
            }).catch(function (e) {
                console.error('åŠ è½½å¤±è´¥:', e);
            });
        }

        // ========== é˜…è¯»å™¨ ==========
        function startReader(src, name, id) {
            if (book) book.destroy();
            currentBookId = id;
            localStorage.setItem('lastBook', id);

            var saved = localStorage.getItem('data_' + id);
            if (saved) {
                try { data = JSON.parse(saved); } catch (e) { }
            } else {
                data = { progress: '', bookmarks: [], highlights: [], config: { color: '#779ECB', lq: '"', rq: '"', aiUrl: '', aiKey: '', aiModel: 'gpt-3.5-turbo', systemPrompt: '' } };
            }

            book = ePub(src);
            rendition = book.renderTo('viewer', { flow: 'scrolled-doc', width: '100%', height: '100%' });

            rendition.themes.default({
                'body': { 'background-color': '#1a1a2e !important', 'color': '#bbb !important', 'max-width': '750px !important', 'margin': '0 auto !important', 'padding': '40px 20px !important', 'text-align': 'justify !important', 'line-height': '1.8 !important' },
                'p': { 'margin-bottom': '1.5em !important', 'text-indent': '2em !important' }
            });

            rendition.hooks.content.register(function (contents) {
                applyQuoteHighlight(contents);
                contents.document.onmouseup = function () {
                    var sel = contents.window.getSelection();
                    if (sel && sel.rangeCount > 0 && !sel.isCollapsed) {
                        currentCfi = contents.cfiFromRange(sel.getRangeAt(0));
                        currentContents = contents;
                        showHighlightMenu(contents);
                    } else {
                        document.getElementById('highlight-menu').style.display = 'none';
                    }
                };
            });

            rendition.on('rendered', function () {
                data.highlights.forEach(function (h) {
                    try {
                        rendition.annotations.add('highlight', h.cfi, {}, null, 'hl', { fill: h.color + '66' });
                    } catch (e) { }
                });
            });

            rendition.display(data.progress || undefined);

            rendition.on('relocated', function (loc) {
                if (loc && loc.start) {
                    data.progress = loc.start.cfi;
                    document.getElementById('page-info').textContent = Math.floor(loc.start.percentage * 100) + '%';
                    saveData();
                }
            });

            book.loaded.navigation.then(function (nav) {
                var container = document.getElementById('toc-container');
                if (!nav || !nav.toc || nav.toc.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;">æ— ç›®å½•</p>';
                    return;
                }
                container.innerHTML = '';
                renderToc(nav.toc, container, 0);
            });

            refreshLibrary();
            refreshHighlights();
            refreshBookmarks();
            updateSettingsUI();
        }

        function renderToc(items, container, level) {
            items.forEach(function (item) {
                var div = document.createElement('div');
                div.className = 'data-item';
                div.style.paddingLeft = (12 + level * 15) + 'px';
                div.innerHTML = '<span class="title">' + (item.label || 'æ— æ ‡é¢˜').trim() + '</span>';
                div.onclick = function () {
                    rendition.display(item.href);
                    toggleSidebar();
                };
                container.appendChild(div);
                if (item.subitems && item.subitems.length > 0) {
                    renderToc(item.subitems, container, level + 1);
                }
            });
        }

        function applyQuoteHighlight(contents) {
            var lq = data.config.lq || '"';
            var rq = data.config.rq || '"';
            var color = data.config.color || '#779ECB';

            contents.addStylesheetRules({ '.auto-hl': { 'color': color + ' !important', 'font-weight': 'bold' } });

            var walker = contents.document.createTreeWalker(contents.document.body, NodeFilter.SHOW_TEXT);
            var nodes = [];
            var node;
            while (node = walker.nextNode()) {
                if (node.parentNode.tagName !== 'SCRIPT' && node.parentNode.tagName !== 'STYLE') {
                    nodes.push(node);
                }
            }

            var escapedLq = lq.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            var escapedRq = rq.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            var regex = new RegExp(escapedLq + '([^' + escapedRq + ']+)' + escapedRq, 'g');

            nodes.forEach(function (n) {
                var text = n.textContent;
                if (!text.includes(lq)) return;
                var frag = contents.document.createDocumentFragment();
                var lastIdx = 0;
                var match;
                while ((match = regex.exec(text)) !== null) {
                    frag.appendChild(contents.document.createTextNode(text.substring(lastIdx, match.index)));
                    var span = contents.document.createElement('span');
                    span.className = 'auto-hl';
                    span.textContent = match[0];
                    frag.appendChild(span);
                    lastIdx = regex.lastIndex;
                }
                if (lastIdx > 0) {
                    frag.appendChild(contents.document.createTextNode(text.substring(lastIdx)));
                    n.parentNode.replaceChild(frag, n);
                }
            });
        }

        // ========== é«˜äº®ä¸ç¬”è®° ==========
        function showHighlightMenu(contents) {
            try {
                var rect = contents.range(currentCfi).getBoundingClientRect();
                var menu = document.getElementById('highlight-menu');
                menu.style.display = 'flex';
                menu.style.top = Math.max(10, rect.top - 55) + 'px';
                menu.style.left = Math.max(10, rect.left + rect.width / 2 - 80) + 'px';
            } catch (e) { }
        }

        function doHighlight(color) {
            if (!currentCfi) return;
            var existing = data.highlights.find(function (h) { return h.cfi === currentCfi; });
            if (existing) {
                existing.color = color;
            } else {
                data.highlights.push({ cfi: currentCfi, color: color, note: '' });
            }
            rendition.annotations.add('highlight', currentCfi, {}, null, 'hl', { fill: color + '66' });
            saveData();
            refreshHighlights();
            document.getElementById('highlight-menu').style.display = 'none';
            if (currentContents) currentContents.window.getSelection().removeAllRanges();
            openNoteModal(currentCfi);
        }

        function refreshHighlights() {
            var container = document.getElementById('highlight-container');
            var filtered = data.highlights.filter(function (h) { return hlFilter === 'all' || h.color === hlFilter; });
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">æš‚æ— é«˜äº®</p>';
                return;
            }
            container.innerHTML = '';
            filtered.forEach(function (h, idx) {
                book.getRange(h.cfi).then(function (r) {
                    var div = document.createElement('div');
                    div.className = 'data-item';
                    div.innerHTML = '<span class="title" style="border-left:4px solid ' + h.color + ';padding-left:10px;">' + (r ? r.toString().substring(0, 30) : 'é«˜äº®') + '...</span>' +
                        (h.note ? '<div class="note-preview"><i class="fas fa-comment"></i> ' + h.note + '</div>' : '') +
                        '<i class="fas fa-trash delete-btn" onclick="event.stopPropagation(); removeHighlight(\'' + h.cfi + '\')"></i>';
                    div.onclick = function () { rendition.display(h.cfi); toggleSidebar(); };
                    container.appendChild(div);
                }).catch(function () { });
            });
        }

        function removeHighlight(cfi) {
            try { rendition.annotations.remove(cfi, 'highlight'); } catch (e) { }
            data.highlights = data.highlights.filter(function (h) { return h.cfi !== cfi; });
            saveData();
            refreshHighlights();
        }

        function openNoteModal(cfi) {
            currentCfi = cfi;
            var hl = data.highlights.find(function (h) { return h.cfi === cfi; });
            document.getElementById('note-text').value = hl ? (hl.note || '') : '';
            document.getElementById('note-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('note-modal').style.display = 'none';
        }

        function saveNote() {
            var text = document.getElementById('note-text').value;
            var hl = data.highlights.find(function (h) { return h.cfi === currentCfi; });
            if (hl) hl.note = text;
            saveData();
            refreshHighlights();
            closeModal();
        }

        // ========== ä¹¦ç­¾ ==========
        function addBookmark() {
            if (!rendition) return alert('è¯·å…ˆåŠ è½½ä¹¦ç±');
            var loc = rendition.currentLocation();
            if (!loc || !loc.start) return;
            var cfi = loc.start.cfi;
            if (data.bookmarks.some(function (b) { return b.cfi === cfi; })) {
                return alert('æ­¤ä½ç½®å·²æœ‰ä¹¦ç­¾');
            }
            book.getRange(cfi).then(function (r) {
                data.bookmarks.push({ cfi: cfi, label: r ? r.toString().substring(0, 25) + '...' : 'ä¹¦ç­¾', time: new Date().toLocaleString() });
                saveData();
                refreshBookmarks();
                alert('ä¹¦ç­¾å·²æ·»åŠ ');
            }).catch(function () {
                data.bookmarks.push({ cfi: cfi, label: 'ä¹¦ç­¾ ' + (data.bookmarks.length + 1), time: new Date().toLocaleString() });
                saveData();
                refreshBookmarks();
            });
        }

        function refreshBookmarks() {
            var container = document.getElementById('bookmark-container');
            if (data.bookmarks.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">æš‚æ— ä¹¦ç­¾</p>';
                return;
            }
            container.innerHTML = data.bookmarks.map(function (b, idx) {
                return '<div class="data-item" onclick="goBookmark(\'' + b.cfi + '\')">' +
                    '<span class="title">' + b.label + '</span>' +
                    '<span style="font-size:10px;color:#555;">' + b.time + '</span>' +
                    '<i class="fas fa-trash delete-btn" onclick="event.stopPropagation(); deleteBookmark(' + idx + ')"></i>' +
                    '</div>';
            }).join('');
        }

        function goBookmark(cfi) {
            rendition.display(cfi);
            toggleSidebar();
        }

        function deleteBookmark(idx) {
            data.bookmarks.splice(idx, 1);
            saveData();
            refreshBookmarks();
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function extractFullText() {
            var fullText = '';
            var items = book.spine.spineItems;
            var promises = items.slice(0, 20).map(function (item) {
                return book.load(item.href).then(function (doc) {
                    if (doc && doc.body) fullText += doc.body.innerText + '\n';
                }).catch(function () { });
            });
            return Promise.all(promises).then(function () { return fullText.substring(0, 50000); });
        }

        // ========== è®¾ç½® ==========
        function updateSettingsUI() {
            // å·¦ä¾§ AI é¢æ¿è®¾ç½®
            var aiUrl = document.getElementById('ai-url');
            var aiKey = document.getElementById('ai-key');
            var aiModel = document.getElementById('ai-model');
            var aiPrompt = document.getElementById('ai-system-prompt');
            if (aiUrl) aiUrl.value = data.config.aiUrl || '';
            if (aiKey) aiKey.value = data.config.aiKey || '';
            if (aiModel) aiModel.value = data.config.aiModel || 'gpt-3.5-turbo';
            if (aiPrompt) aiPrompt.value = data.config.systemPrompt || '';
            // å³ä¾§å¼•å·è®¾ç½®
            var cfgColor = document.getElementById('cfg-color');
            var cfgLq = document.getElementById('cfg-lq');
            var cfgRq = document.getElementById('cfg-rq');
            if (cfgColor) cfgColor.value = data.config.color || '#779ECB';
            if (cfgLq) cfgLq.value = data.config.lq || '"';
            if (cfgRq) cfgRq.value = data.config.rq || '"';
        }

        function saveSettings() {
            // å·¦ä¾§ AI é¢æ¿è®¾ç½®
            var aiUrl = document.getElementById('ai-url');
            var aiKey = document.getElementById('ai-key');
            var aiModel = document.getElementById('ai-model');
            var aiPrompt = document.getElementById('ai-system-prompt');
            if (aiUrl) data.config.aiUrl = aiUrl.value;
            if (aiKey) data.config.aiKey = aiKey.value;
            if (aiModel) data.config.aiModel = aiModel.value;
            if (aiPrompt) data.config.systemPrompt = aiPrompt.value;
            // å³ä¾§å¼•å·è®¾ç½®
            var cfgColor = document.getElementById('cfg-color');
            var cfgLq = document.getElementById('cfg-lq');
            var cfgRq = document.getElementById('cfg-rq');
            if (cfgColor) data.config.color = cfgColor.value;
            if (cfgLq) data.config.lq = cfgLq.value;
            if (cfgRq) data.config.rq = cfgRq.value;
            saveData();
            alert('è®¾ç½®å·²ä¿å­˜');
        }

        var promptPresets = {
            reader: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é˜…è¯»åŠ©æ‰‹ï¼Œæ“…é•¿æ·±åº¦è§£è¯»æ–‡æœ¬ï¼Œåˆ†æä½œè€…æ„å›¾å’Œæ–‡å­¦æŠ€å·§ï¼Œå¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£ä¹¦ç±å†…å®¹ã€‚å›ç­”æ—¶è¯·ä½¿ç”¨ Markdown æ ¼å¼ï¼ŒåŒ…å«æ¸…æ™°çš„æ ‡é¢˜å’Œæ¡ç†åˆ†æ˜çš„è¦ç‚¹ã€‚',
            analyst: 'ä½ æ˜¯ä¸€ä½å­¦æœ¯åˆ†æä¸“å®¶ï¼Œå–„äºè¿›è¡Œæ·±å±‚æ¬¡çš„æ–‡æœ¬åˆ†æï¼ŒåŒ…æ‹¬ä¸»é¢˜æŒ–æ˜ã€è±¡å¾æ„ä¹‰è§£è¯»ã€å†å²èƒŒæ™¯åˆ†æç­‰ã€‚è¯·æä¾›è¯¦å°½çš„å­¦æœ¯çº§è§£è¯»ï¼Œä½¿ç”¨ Markdown æ ¼å¼ç»„ç»‡ç­”æ¡ˆã€‚',
            teacher: 'ä½ æ˜¯ä¸€ä½è€å¿ƒçš„æ•™å¸ˆï¼Œæ“…é•¿ç”¨é€šä¿—æ˜“æ‡‚çš„æ–¹å¼è§£é‡Šå¤æ‚æ¦‚å¿µã€‚å›ç­”æ—¶è¯·å¾ªåºæ¸è¿›ï¼Œä½¿ç”¨ä¾‹å­å’Œç±»æ¯”å¸®åŠ©ç†è§£ï¼Œé€‚å½“æå‡ºæ€è€ƒé—®é¢˜å¼•å¯¼æ·±å…¥å­¦ä¹ ã€‚ä½¿ç”¨ Markdown æ ¼å¼ã€‚',
            translator: 'ä½ æ˜¯ä¸€ä½ç²¾é€šå¤šè¯­è¨€çš„ç¿»è¯‘ä¸“å®¶ï¼Œèƒ½å¤Ÿå‡†ç¡®ä¼ è¾¾åŸæ–‡çš„å«ä¹‰å’Œè¯­æ°”ã€‚ç¿»è¯‘æ—¶ä¿æŒåŸæ–‡çš„é£æ ¼å’Œè¯­æ„Ÿï¼Œå¿…è¦æ—¶æä¾›æ³¨é‡Šè¯´æ˜æ–‡åŒ–èƒŒæ™¯ã€‚ä½¿ç”¨ Markdown æ ¼å¼ã€‚'
        };

        function setPromptPreset(type) {
            if (promptPresets[type]) {
                document.getElementById('ai-system-prompt').value = promptPresets[type];
            }
        }

        function saveData() {
            if (currentBookId) {
                localStorage.setItem('data_' + currentBookId, JSON.stringify(data));
            }
        }
    </script>
</body>

</html>